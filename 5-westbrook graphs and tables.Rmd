cross-validation
rmse by river,year



```{r load data}
baseDir <- getwd() # works as long as you have the project loaded in RStudio - does not work for kniting

dataInDir <- paste0(baseDir, '/dataIn/')
dataOutDir <- paste0(baseDir, '/dataOut/')
dataLocalDir <- paste0(baseDir, '/localData/')
graphsDir <- paste0(baseDir, '/graphs/')
codeDir <- paste0(baseDir, '/code/')

load(paste0(dataLocalDir,'means.RData'))
load(paste0(dataLocalDir,'tempDataSyncSUsed.RData'))

```

```{r raw data graphs}
# raw unstandardized are in tempDataSync

tempDataSync$river <- 'WEST BROOK'
tempDataSync$river[ tempDataSync$site == 'MAUSGS_WB_MITCHELL' ] <- 'WB MITCHELL' 
tempDataSync$river[ tempDataSync$site == 'MAUSGS_WB_OBEAR' ] <- 'WB OBEAR' 
tempDataSync$river[ tempDataSync$site == 'MAUSGS_WB_JIMMY' ] <- 'WB JIMMY' 
tempDataSync$riverOrdered <- factor(tempDataSync$river,levels=c('WEST BROOK','WB JIMMY','WB MITCHELL','WB OBEAR'), ordered=T)

ggRawJimmy <- 
ggplot(tempDataSync[tempDataSync$riverOrdered == 'WB JIMMY',],aes(dOY,temp))+
  geom_line(size=0.5)+
  geom_line(aes(dOY,airTemp),color='red',size=0.5)+
  scale_x_continuous("Day of year") +
  scale_y_continuous(expression(paste("Temperature ( ",degree, "C)", sep = ""))) +
  theme_bw(base_size=25)+
  facet_wrap(~year)

ggsave( file=paste0(graphsDir,'ggRawJimmy.png'), plot=ggRawJimmy, dpi=600 , width=8,height=5, units='in', scale=2 )

```

Model validation

```{r obs v pred}

#observed vs. predicted
obsPred <- 
ggplot(tempDataSyncS[tempDataSyncS$year>2006,], aes(temp, pred.wb)) +
    geom_point(alpha = 0.3) + 
    geom_abline(intercept=0,slope=1) + 
    theme_bw() +
    facet_grid(year~riverOrdered)

ggsave( file=paste0(graphsDir,'obsPred.png'), plot=obsPred, dpi=600 , width=8,height=5, units='in', scale=2 )

```


```{r means tables with rHat}

intersectSeveral <- function(...) { Reduce(intersect, list(...)) } 

# exclude the variables in the grep() statement
# intersect works on pairs. the intersectSeveral function generates the intersection of multiple lists
keepRows <- 
  intersectSeveral(grep("residuals", x=ggs.wb$Parameter,invert=TRUE),
                   grep("stream.mu", x=ggs.wb$Parameter,invert=TRUE),
                   grep("rho.B.year",x=ggs.wb$Parameter,invert=TRUE)
                  )

rHat <- unique( ggs_Rhat(ggs.wb[keepRows,])$data )

# table of parameter estimates for MS
m <- left_join(means,rHat[,c('Parameter','Rhat')])




ggs_caterpillar(ggs.wb[keepRows,])



```




```{r predictions of cubic by year}

pC <- predCubic(means)

ggCubic <- ggplot(pC$predCubic, aes(dOY,pred)) + geom_line(aes(color=factor(year)),size=1.25)

ggCubic + geom_point(aes(maxX,maxY), data = pC$bY)

# max temp over years
ggplot(pC$bY, aes(year,maxY)) + geom_point() + geom_smooth(method="lm")

# day of max temp over years
ggplot(pC$bY, aes(year,maxX)) + geom_point() + geom_smooth(method="lm")

# day of max temp over years
bYM <- melt(pC$bY[,c('year','dOYMinus2','dOYMinus1','dOYPlus1','dOYPlus2')],id='year') 
bYM$std <- ifelse(bYM$variable %in% c('dOYMinus1','dOYPlus1'), 1, 2 ) 
bYM$tempAdj <- bYM$value + 18 # 18 for now as a fill-in

predCubicStd <- 
  ggplot(bYM, aes(year,tempAdj,color=variable,shape=variable)) +
  geom_point(size=3) +
  geom_smooth(method="lm") +
  facet_wrap(~std, scales = "free")

ggsave( file=paste0(graphsDir,'predCubicStd.png'), plot=predCubicStd, dpi=600 , width=6,height=6, units='in' )

# none of these is significant
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYMinus2',] ))
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYMinus1',] ))
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYPlus1',] ))
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYPlus2',] ))
```
