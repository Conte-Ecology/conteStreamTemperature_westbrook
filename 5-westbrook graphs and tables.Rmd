cross-validation
rmse by river,year
```{r libraries}
library(gridExtra)
```



```{r load data}
baseDir <- getwd() # works as long as you have the project loaded in RStudio - does not work for kniting

dataInDir <- paste0(baseDir, '/dataIn/')
dataOutDir <- paste0(baseDir, '/dataOut/')
dataLocalDir <- paste0(baseDir, '/localData/')
graphsDir <- paste0(baseDir, '/graphs/')
codeDir <- paste0(baseDir, '/code/')

load(paste0(dataLocalDir,'means.RData'))
load(paste0(dataLocalDir,'tempDataSyncSUsed.RData'))
#load(paste0(dataLocalDir,'tempDataSync.RData'))

```


```{r daymet airTemp vs WB airTemp}

load(paste0(dataInDir,'MAUSGS/westbrookAirTempComparison_Paper.RData'))
load(paste0(dataOutDir, 'springFallBreakpoints.RData'))

airTempComparison <- left_join( airTempComparison,springFallBPs[springFallBPs$site=='MAUSGS_WEST_BROOK',],by='year')

# Clip to syncronized season
airTempComparison <- filter(airTempComparison, dOY >= finalSpringBP & dOY <= finalFallBP)

summary(lm(meanAirTemp_WB~meanAirTemp_Day, data=airTempComparison))

ggAirTempComparison <- 
ggplot(airTempComparison,aes(meanAirTemp_WB,meanAirTemp_Day))+
  geom_point()+
  geom_abline(intercept=0,slope=1) +
  geom_smooth(method='lm') +
  scale_x_continuous(expression(paste("Air temperature from WB ( ",degree, "C)", sep = ""))) +
  scale_y_continuous(expression(paste("Air temperature from dayMet ( ",degree, "C)", sep = ""))) +
  theme_bw(base_size=25)+
  facet_wrap(~year)

ggsave( file=paste0(graphsDir,'ggAirTempComparison.png'), plot=ggAirTempComparison, dpi=600 , width=6,height=5, units='in', scale=2 )


ggplot(airTempComparison,aes(dOY,meanAirTemp_Day))+
  geom_point()+
  geom_line()+
  geom_point(aes(dOY,meanAirTemp_WB),color='red') +
    geom_line(aes(dOY,meanAirTemp_WB),color='red') +
  scale_x_continuous(expression(paste("Air temperature from WB ( ",degree, "C)", sep = ""))) +
  scale_y_continuous(expression(paste("Air temperature from dayMet ( ",degree, "C)", sep = ""))) +
  theme_bw(base_size=25)+
  facet_wrap(~year)

#max air temp
ggplot(airTempComparison,aes(dOY,maxAirTemp_Day))+
  geom_point()+
  geom_line()+
  geom_point(aes(dOY,maxAirTemp_WB),color='red') +
    geom_line(aes(dOY,maxAirTemp_WB),color='red') +
  scale_x_continuous(expression(paste("Air temperature from WB ( ",degree, "C)", sep = ""))) +
  scale_y_continuous(expression(paste("Air temperature from dayMet ( ",degree, "C)", sep = ""))) +
  theme_bw(base_size=25)+
  facet_wrap(~year)


```


```{r raw data graphs}
# raw unstandardized are in tempDataSync


###################################################
# graph with tempIndex and breaks for illustration
# tempIndex is in e, not in tempDataSyncS

# to get quantiles
load(paste0(dataOutDir, 'springFallBreakpoints.RData'))
#has temp, airTemp, and tempIndex
load(paste0(dataLocalDir,'e.RData'))

e$river <- 'WEST BROOK'
e$river[ e$site == 'MAUSGS_WB_MITCHELL' ] <- 'WB MITCHELL' 
e$river[ e$site == 'MAUSGS_WB_OBEAR' ] <- 'WB OBEAR' 
e$river[ e$site == 'MAUSGS_WB_JIMMY' ] <- 'WB JIMMY' 
e$riverOrdered <- factor(e$river,levels=c('WEST BROOK','WB JIMMY','WB MITCHELL','WB OBEAR'), ordered=T)

ggplot(e, aes(dOY,temp)) + geom_point() + facet_grid(year~riverOrdered)

###
ggRawWB <- 
ggplot(e[e$riverOrdered == 'WEST BROOK' & e$year %in% 2003:2004,],aes(dOY,temp))+
  geom_line(size=0.5)+
  geom_line(aes(dOY,airTemp),color='red',size=0.5)+
  scale_x_continuous(lim=c(0,360)) +
  scale_y_continuous("Temperature (C)") +
#    scale_y_continuous(expression(paste("Temperature ( ",degree, "C)", sep = ""))) + #this results in panels not lining up
      geom_vline( aes(xintercept=finalSpringBP), data=springFallBPs[springFallBPs$year %in% 2003:2004 & springFallBPs$site == 'MAUSGS_WEST_BROOK',] ) +
      geom_vline( aes(xintercept=finalFallBP), data=springFallBPs[springFallBPs$year %in% 2003:2004 & springFallBPs$site == 'MAUSGS_WEST_BROOK',] ) +
  theme_bw(base_size=25)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~year)

ggsave( file=paste0(graphsDir,'ggRawWB.png'), plot=ggRawWB, dpi=600 , width=6,height=5, units='in', scale=2 )


ggWBBPs <- 
ggplot(e[e$riverOrdered == 'WEST BROOK' & e$year %in% 2003:2004,],aes(dOY,movingMean))+
  geom_point()+
 # geom_line(aes(dOY,airTemp),color='red',size=0.5)+
  geom_hline( aes(yintercept=quantileLo), data=springFallBPs[springFallBPs$year %in% 2003:2004 & springFallBPs$site == 'MAUSGS_WEST_BROOK',] ) +
  geom_hline( aes(yintercept=quantileHi), data=springFallBPs[springFallBPs$year %in% 2003:2004 & springFallBPs$site == 'MAUSGS_WEST_BROOK',] ) +
    geom_vline( aes(xintercept=finalSpringBP), data=springFallBPs[springFallBPs$year %in% 2003:2004 & springFallBPs$site == 'MAUSGS_WEST_BROOK',] ) +
      geom_vline( aes(xintercept=finalFallBP), data=springFallBPs[springFallBPs$year %in% 2003:2004 & springFallBPs$site == 'MAUSGS_WEST_BROOK',] ) +
  scale_x_continuous("Day of year",lim=c(0,360)) +
  scale_y_continuous("Temperature Index",lim=c(-25,25) ) +
  theme_bw(base_size=25) +
  theme(strip.text.x = element_blank(),
        strip.background = element_blank()) +
  #ylim(-5,30) +
  facet_wrap(~year)

rawWB <- arrangeGrob(ggRawWB, ggWBBPs,ncol=1)#, widths=c(5,1.5))  

ggsave( file=paste0(graphsDir,'rawWB.png'), plot=rawWB, dpi=600 , width=6,height=5, units='in', scale=2 )


```


```{r characterize years - hot, cold seasons}

ggGam <- 
ggplot(tempDataSyncS,aes(dOYInt,temp)) + geom_point() +geom_smooth(se=F,color='white',size=2.5) +
  scale_x_continuous("Day of Year") +
  scale_y_continuous("Temperature (C)") +
  theme_bw(base_size=25)

ggsave( file=paste0(graphsDir,'ggGam.png'), plot=ggGam, dpi=600 , width=6,height=5, units='in', scale=2 )


gGam <- gam(temp~s(dOY),data=tempDataSyncS)
g <- data.frame(s=tempDataSyncS$site,y=tempDataSyncS$year,dOY=tempDataSyncS$dOY,r=gGam$residuals,f=gGam$fitted.values)
ggplot(g, aes(dOY,r)) +geom_point() + geom_hline(yintercept=0) + facet_grid(y~s)

gSum <- 
  g %>%
  group_by(s,y)%>%
  mutate( cR = cumsum(r) )

ggplot(gSum, aes(dOY,cR)) + geom_point() + geom_hline(yintercept=0) + facet_grid(y~s)


```




Model validation

```{r obs v pred}

#observed vs. predicted
obsPred <- 
ggplot(tempDataSyncS[tempDataSyncS$year>2006,], aes(temp, pred.wb)) +
    geom_point(alpha = 0.3) + 
    geom_abline(intercept=0,slope=1) + 
    scale_x_continuous( expression(paste("Observed temperature ( ",degree, "C)", sep = ""))) +
    scale_y_continuous( expression(paste("Predicted temperature ( ",degree, "C)", sep = ""))) +
    theme_bw(base_size=25) +
    facet_grid(year~riverOrdered)

ggsave( file=paste0(graphsDir,'obsPred.png'), plot=obsPred, dpi=600, width=8,height=5, units='in', scale=2 )

```


```{r means tables with rHat}

intersectSeveral <- function(...) { Reduce(intersect, list(...)) } 

# exclude the variables in the grep() statement
# intersect works on pairs. the intersectSeveral function generates the intersection of multiple lists
keepRows <- 
  intersectSeveral(grep("residuals", x=ggs.wb$Parameter,invert=TRUE),
                   grep("stream.mu", x=ggs.wb$Parameter,invert=TRUE),
                   grep("rho.B.year",x=ggs.wb$Parameter,invert=TRUE)
                  )

rHat <- unique( ggs_Rhat(ggs.wb[keepRows,])$data )
rHat$Rhat1 <- ifelse(rHat$Rhat < 1,1,rHat$Rhat)
max(rHat$Rhat1,na.rm=T)

# table of parameter estimates for MS
m <- left_join( rHat[,c('Parameter','Rhat')], means )

#ggs_caterpillar(ggs.wb[keepRows,])
m$gt2 <- ifelse( m$mean > 2, 1,0 )
m$oP <- factor(m$Parameter,levels=rev( c(
 'B.0[1]','B.0[2]','B.0[3]','B.0[4]','B.0[5]','B.0[6]','B.0[7]','B.0[8]','B.0[9]','B.0[10]','B.0[11]','B.0[12]','mu.year[1]','mu.year[2]','mu.year[3]','mu.year[4]','ar1Mean','ar1SD','ar1[1]','ar1[2]','ar1[3]','ar1[4]','mu.year[1]','mu.year[2]','mu.year[3]','mu.year[4]','sigma'
 ) ), ordered=T)

# without B.year[]
# do in two parts to simulate a 'break'
b1 <- 
ggplot(m[grep("B.year",m$Parameter,invert=T) & !is.na(m$oP),], aes(x = mean, y = oP)) + 
  geom_point(size = 3) + 
  geom_segment(aes(x = qLo, xend = qHi, yend = oP), size = 0.5) +
  geom_segment(aes(x = qLo25, xend = qHi75, yend = oP), size = 1.5) +
  theme_bw(base_size=25) +
  scale_x_continuous('        Value',limits=c(-2.7,2)) +
  scale_y_discrete('Parameter') +
  geom_vline(xintercept=0) +
  theme(#axis.text.x = element_text(angle=50),
        strip.text.x = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        plot.margin= unit(c(1,0.05,1,1), "lines"))
 
b2 <- 
ggplot(m[grep("B.year",m$Parameter,invert=T) & !is.na(m$oP),], aes(x = mean, y = oP)) + 
  geom_point(size = 3) + 
  geom_segment(aes(x = qLo, xend = qHi, yend = oP), size = 0.5) +
  geom_segment(aes(x = qLo25, xend = qHi75, yend = oP), size = 1.5) +
  theme_bw(base_size=25) +
  scale_x_continuous('',limits=c(14.4,15.6), breaks=c(14.5,15.5)) +
  scale_y_discrete('') +
  #facet_grid( ~ gt2, scales='free_x',space='free' ) +
  theme(axis.text.y = element_blank(),
        strip.text.x = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        plot.margin= unit(c(1,1,1,0), "lines"))
  

betas <- arrangeGrob(b1, b2,ncol=2, widths=c(5,1.5))  

ggsave( file=paste0(graphsDir,'betas.png'), plot=betas, dpi=600, width=5,height=5, units='in', scale=2 )


# B.year[] only
ggplot(m[grep("B.year",m$Parameter,invert=F),], aes(x = mean, y = reorder(Parameter,mean))) + 
  geom_point(size = 3) + 
  geom_segment(aes(x = qLo, xend = qHi, yend = reorder(Parameter,mean)), size = 0.5) +
  geom_segment(aes(x = qLo25, xend = qHi75, yend = reorder(Parameter,mean)), size = 1.5)


```


```{r trend in bPs?}

bP <- unique( tempDataSyncS[,c("year","riverOrdered",'finalSpringBP','finalFallBP')] )
bPM <- melt(bP, id.var=c('year','riverOrdered'))

ggBP <- 
ggplot( bPM[bPM$year>2001,], aes( year,value,color=riverOrdered ) ) +
  geom_point(aes(shape=riverOrdered),size=5)+
  #geom_line(aes( linetype=riverOrdered)) +
  scale_x_continuous('Year') +
  scale_y_continuous( 'Day of year' ) +
  geom_smooth(aes( linetype=riverOrdered),method='lm',se=F)+
  theme_bw(base_size=25) +
  facet_wrap(~variable, ncol=1, scales='free')

ggsave( file=paste0(graphsDir,'ggBP.png'), plot=ggBP, dpi=600, width=5,height=5, units='in', scale=2 )



```


```{r predictions of cubic by year}

pC <- predCubic(means)

ggCubic <- 
  ggplot(pC$predCubic, aes(dOY,pred)) + geom_line(aes(group=factor(year)),size=1.25) +
    geom_point(aes(maxX,maxY), color='white',data = pC$bY) +
    scale_x_continuous('Day of year') +
    scale_y_continuous( expression(paste("Cubic trend effect ( ",degree, "C)", sep = ""))) +
    theme_bw(base_size=20)

ggsave( file=paste0(graphsDir,'ggCubic.png'), plot=ggCubic, dpi=600 , width=6,height=6, units='in' )



ggCubic + geom_point(aes(maxX,maxY), data = pC$bY) +facet_wrap(~year)

# max temp over years
ggplot(pC$bY, aes(year,maxY)) + geom_point() + geom_smooth(method="lm")

# day of max temp over years
ggplot(pC$bY, aes(year,maxX)) + geom_point() + geom_smooth(method="lm")

# day of max temp over years
bYM <- melt(pC$bY[,c('year','dOYMinus2','dOYMinus1','dOYPlus1','dOYPlus2')],id='year') 
bYM$std <- ifelse(bYM$variable %in% c('dOYMinus1','dOYPlus1'), 1, 2 ) 
bYM$tempAdj <- bYM$value + 18 # 18 for now as a fill-in

predCubicStd <- 
  ggplot(bYM, aes(year,tempAdj,linetype=variable,shape=variable)) +
  geom_point(size=3) +
  geom_smooth(method="lm",color='black') +
  scale_x_continuous('Year') +
  scale_y_continuous( expression(paste("Temperature ( ",degree, "C)", sep = ""))) +
  theme_bw(base_size=25) +
  theme( legend.position="none")# +
#  facet_wrap(~std, scales = "free")

ggsave( file=paste0(graphsDir,'predCubicStd.png'), plot=predCubicStd, dpi=600 , width=6,height=6, units='in' )

# test significance
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYMinus2',] ))
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYMinus1',] ))
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYPlus1',] ))
summary(lm( tempAdj ~ year, data=bYM[bYM$variable == 'dOYPlus2',] ))
```


```{r plots for cross-validation}
load( paste0(dataLocalDir, "r.RData"))

#ggplot( r[r$incompleteYear & !is.na(r$riverOrdered),], aes(incompleteIndex,diff)) + geom_point()+facet_wrap(~rivsIndex)


meansByS <-   
r %>%
  filter( incompleteYear,numD > 20, rivsIndex==1 & riverOrdered=='WEST BROOK' | rivsIndex==2 ) %>%
  group_by( rivsIndex,scenario ) %>%
    summarise( mean = mean( diff, na.rm=T ),
               sd   =   sd( diff, na.rm=T ),
               n    =    n(  ),
             dOYDiff = min(dOYDiff),
             numD = mean( numD, na.rm=T ),
             numDSD = sd( numD, na.rm=T ),
                  s = unique(s)) %>%
  filter( !is.na( s )
         # , s=='middle' 
         ) %>%
  mutate( dOYDiff = ifelse( dOYDiff == -Inf,0, dOYDiff ) ) 


ggplot( r[r$propD>0,] ,aes(numD,diff, color=rivsIndex
          #     ,shape=factor(s)
               )) +
  geom_point()+#aes(color=factor(s)) ) +
  facet_grid(scenario~riverOrdered)


ggRMSEDOY <- 
ggplot( meansByS[meansByS$s=='middle',] ,aes(numD,mean
               ,shape=factor(rivsIndex)
               )) +
  geom_point( size=4 ) +
  geom_smooth(method='lm'
              , formula=y~x+I(x^2)
              ,se=F,color='black') +
  geom_point( aes(dOYDiff,mean), data=meansByS[meansByS$s == 'earlyChunk',], shape=1,size=4 ) +
  geom_point( aes(dOYDiff,mean), data=meansByS[meansByS$s == 'lateChunk',], shape=5,size=3  ) +
  scale_x_continuous('Number of days included in estimation') +
  scale_y_continuous('Difference in RMSE from base case') +
  theme_bw(base_size=25) +
  theme(legend.position="none") 

ggsave( file=paste0(graphsDir,'ggRMSEDOY.png'), plot=ggRMSEDOY, dpi=600 , width=6,height=5, units='in', scale=2 )

# break it up by river and year
r$rY <- paste0(r$riverOrdered,r$year)

ggMiddleScenarios <- 
ggplot( na.omit(r[r$s %in% c('0days','middle') 
                  & r$riverOrdered == "WEST BROOK"
                  ,]) ,aes(numD,diff
          #     ,shape=factor(s)
                ,color=factor(rivsIndex)
               )) +
  geom_point(  ) +
  geom_smooth(method='lm'
              #, formula=y~x+I(x^2)
              ,se=F)+#,color='black') +
  scale_x_continuous('Number of days included in estimation') +
  scale_y_continuous('Difference in RMSE from base case') +
  theme_bw(base_size=25) +
  theme(legend.position="none") +
  facet_wrap(~year)

ggsave( file=paste0(graphsDir,'ggMiddleScenarios.png'), plot=ggMiddleScenarios, dpi=600 , width=8,height=5, units='in', scale=2 )


#6=2002, 11=2007, 13=2009
for(i in 13:21){print(ggObsPred[[16+16*i]])}


```

```{r look at 30day patterns}

gg30DayScenarios <- 
ggplot( na.omit(r[r$s %in% c('30days') 
                  & r$riverOrdered == "WEST BROOK"
                  & r$numD == 30
                  ,]) ,aes(70+scenario*20,diff  
                ,shape=factor(rivsIndex)
                ,color=factor(rivsIndex)
               )) +
  geom_point(  ) +
  geom_smooth(method='lm'
              ,formula=y~x+I(x^2) #+I(x^3)
              ,se=F)+#,color='black') +
  scale_x_continuous('Starting day (day of year)') +
  scale_y_continuous('Difference in RMSE from base case') +
  theme_bw(base_size=25) +
  theme(legend.position="none") +
  facet_wrap(~year)

ggsave( file=paste0(graphsDir,'gg30DayScenarios.png'), plot=gg30DayScenarios, dpi=600 , width=8,height=5, units='in', scale=2 )



```

```{r look at cumulative rmse}
# cumulResid <- 
# predictSummary %>%
#   group_by(scenario,yearOut) %>%
#   mutate( c = cumsum(resid) )
# 
# ggplot(cumulResid, aes(dOYInt,c)) +
#   geom_point()
```

